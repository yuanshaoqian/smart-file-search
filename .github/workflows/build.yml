name: Build Windows Release (Lightweight)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PyQt6 whoosh python-docx openpyxl PyYAML loguru watchdog chardet
        
    - name: Build executable
      run: |
        pyinstaller --clean --onefile --windowed --name SmartFileSearch src/main.py --add-data "config.yaml;." --hidden-import PyQt6.QtCore --hidden-import PyQt6.QtGui --hidden-import PyQt6.QtWidgets --hidden-import whoosh --hidden-import docx --hidden-import openpyxl --hidden-import yaml --hidden-import loguru
        
    - name: Create portable version (without AI model)
      run: |
        # åˆ›å»ºä¾¿æºç‰ˆç›®å½•ç»“æ„
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable
        Copy-Item dist\SmartFileSearch.exe dist\SmartFileSearch-Portable\
        Copy-Item config.yaml dist\SmartFileSearch-Portable\
        Copy-Item README.md dist\SmartFileSearch-Portable\
        Copy-Item start.bat dist\SmartFileSearch-Portable\
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable\data\models
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable\data\indexdir
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable\logs
        
        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        Set-Content -Path "dist\SmartFileSearch-Portable\ä½¿ç”¨è¯´æ˜.txt" -Value "Smart File Search ä¾¿æºç‰ˆ`n`nä½¿ç”¨æ–¹æ³•ï¼š`n1. åŒå‡» start.bat å¯åŠ¨ç¨‹åº`n2. AIæ¨¡å‹å°†åœ¨é¦–æ¬¡ä½¿ç”¨AIåŠŸèƒ½æ—¶è‡ªåŠ¨ä¸‹è½½`n3. æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æœ¬ç›®å½•ä¸­`n`nç‰¹ç‚¹ï¼š`n- æ— éœ€å®‰è£…ï¼Œè§£å‹å³ç”¨`n- çº¦80MBï¼ˆä¸å«AIæ¨¡å‹ï¼‰`n- AIæ¨¡å‹æŒ‰éœ€ä¸‹è½½ï¼ˆçº¦1.7GBï¼‰"
        
        # æ‰“åŒ…ä¾¿æºç‰ˆ
        Compress-Archive -Path dist\SmartFileSearch-Portable -DestinationPath dist\SmartFileSearch-Portable.zip
      shell: pwsh
        
    - name: Create full version (with AI model)
      run: |
        # ä¸‹è½½AIæ¨¡å‹
        Write-Host "æ­£åœ¨ä¸‹è½½AIæ¨¡å‹..."
        New-Item -ItemType Directory -Force -Path data\models
        Invoke-WebRequest -Uri "https://huggingface.co/TheBloke/phi-2-GGUF/resolve/main/phi-2.Q4_K_M.gguf" -OutFile "data\models\phi-2.Q4_K_M.gguf"
        
        # åˆ›å»ºå®Œæ•´ç‰ˆç›®å½•ç»“æ„
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Full
        Copy-Item dist\SmartFileSearch.exe dist\SmartFileSearch-Full\
        Copy-Item -Recurse data dist\SmartFileSearch-Full\
        Copy-Item config.yaml dist\SmartFileSearch-Full\
        Copy-Item README.md dist\SmartFileSearch-Full\
        Copy-Item start.bat dist\SmartFileSearch-Full\
        
        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        Set-Content -Path "dist\SmartFileSearch-Full\ä½¿ç”¨è¯´æ˜.txt" -Value "Smart File Search å®Œæ•´ç‰ˆ`n`nä½¿ç”¨æ–¹æ³•ï¼š`n1. åŒå‡» start.bat å¯åŠ¨ç¨‹åº`n2. AIæ¨¡å‹å·²åŒ…å«ï¼Œå¯ç›´æ¥ä½¿ç”¨AIåŠŸèƒ½`n`nç‰¹ç‚¹ï¼š`n- æ— éœ€å®‰è£…ï¼Œè§£å‹å³ç”¨`n- åŒ…å«AIæ¨¡å‹ï¼ˆçº¦1.8GBï¼‰`n- AIåŠŸèƒ½ç«‹å³å¯ç”¨"
        
        # æ‰“åŒ…å®Œæ•´ç‰ˆ
        Compress-Archive -Path dist\SmartFileSearch-Full -DestinationPath dist\SmartFileSearch-Full.zip
      shell: pwsh
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SmartFileSearch-Windows
        path: |
          dist/SmartFileSearch.exe
          dist/SmartFileSearch-Portable.zip
          dist/SmartFileSearch-Full.zip
          
    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: Smart File Search ${{ github.ref_name }}
        body: |
          # Smart File Search ${{ github.ref_name }}
          
          ## ğŸ“¦ ä¸‹è½½é€‰é¡¹
          
          ### ğŸš€ ä¾¿æºç‰ˆï¼ˆæ¨èï¼‰
          - **æ–‡ä»¶**: `SmartFileSearch-Portable.zip`
          - **å¤§å°**: çº¦ 80MB
          - **ç‰¹ç‚¹**: 
            - æ— éœ€å®‰è£…ï¼Œè§£å‹å³ç”¨
            - AIæ¨¡å‹æŒ‰éœ€ä¸‹è½½ï¼ˆé¦–æ¬¡ä½¿ç”¨AIåŠŸèƒ½æ—¶ï¼‰
            - é€‚åˆä½é…ç½®ç”µè„‘
          
          ### ğŸ“¦ å®Œæ•´ç‰ˆ
          - **æ–‡ä»¶**: `SmartFileSearch-Full.zip`
          - **å¤§å°**: çº¦ 1.8GB
          - **ç‰¹ç‚¹**:
            - åŒ…å«AIæ¨¡å‹
            - AIåŠŸèƒ½ç«‹å³å¯ç”¨
            - é€‚åˆé«˜é…ç½®ç”µè„‘
          
          ### âš¡ å•æ–‡ä»¶ç‰ˆ
          - **æ–‡ä»¶**: `SmartFileSearch.exe`
          - **å¤§å°**: çº¦ 80MB
          - **ç‰¹ç‚¹**:
            - å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
            - éœ€è¦æ‰‹åŠ¨é…ç½®
            - é€‚åˆé«˜çº§ç”¨æˆ·
          
          ## ğŸš€ å¿«é€Ÿå¼€å§‹
          
          ### ä¾¿æºç‰ˆ/å®Œæ•´ç‰ˆä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”çš„ zip æ–‡ä»¶
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `start.bat` è¿è¡Œ
          
          ### å•æ–‡ä»¶ç‰ˆä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `SmartFileSearch.exe`
          2. åŒå‡»è¿è¡Œ
          3. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºå¿…è¦ç›®å½•
          
          ## ğŸ“¦ åŠŸèƒ½ç‰¹æ€§
          
          - âœ… å¿«é€Ÿæ–‡ä»¶ç´¢å¼•ï¼ˆWhooshï¼‰
          - âœ… å¯åŠ¨ç”»é¢æ˜¾ç¤ºåŠ è½½è¿›åº¦
          - âœ… å¤šçº¿ç¨‹å¤„ç†ï¼Œç•Œé¢æµç•…
          - âœ… æ”¯æŒWord/Excel/TXT
          - âœ… PyQt6ç°ä»£åŒ–ç•Œé¢
          - âœ… AIè‡ªç„¶è¯­è¨€æœç´¢ï¼ˆå¯é€‰ï¼‰
          
          ## ğŸ’¡ ç‰ˆæœ¬åŒºåˆ«
          
          | ç‰ˆæœ¬ | å¤§å° | AIæ¨¡å‹ | é€‚ç”¨åœºæ™¯ |
          |------|------|--------|---------|
          | ä¾¿æºç‰ˆ | 80MB | æŒ‰éœ€ä¸‹è½½ | ä½é…ç½®ã€å¿«é€Ÿè¯•ç”¨ |
          | å®Œæ•´ç‰ˆ | 1.8GB | å·²åŒ…å« | é«˜é…ç½®ã€ç¦»çº¿ä½¿ç”¨ |
          | å•æ–‡ä»¶ | 80MB | æŒ‰éœ€ä¸‹è½½ | é«˜çº§ç”¨æˆ· |
          
          ## âš™ï¸ ç³»ç»Ÿè¦æ±‚
          
          - **æ“ä½œç³»ç»Ÿ**: Windows 10/11
          - **å†…å­˜**: 4GBï¼ˆæ— AIï¼‰/ 8GBï¼ˆæœ‰AIï¼‰
          - **ç£ç›˜ç©ºé—´**: 100MBï¼ˆæ— AIï¼‰/ 2GBï¼ˆæœ‰AIï¼‰
          
          ## ğŸ“š æ–‡æ¡£
          
          - [ä½¿ç”¨è¯´æ˜](docs/USAGE.md)
          - [é…ç½®æŒ‡å—](docs/QUICK_SETUP.md)
          - [ä½é…ç½®ä¼˜åŒ–](docs/LOW_SPEC_GUIDE.md)
          
        files: |
          dist/SmartFileSearch.exe
          dist/SmartFileSearch-Portable.zip
          dist/SmartFileSearch-Full.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
