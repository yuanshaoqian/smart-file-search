name: Build Windows Release (Lightweight)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PyQt6 whoosh python-docx openpyxl PyYAML loguru watchdog chardet
        
    - name: Build executable
      run: |
        pyinstaller --clean --onefile --windowed --name SmartFileSearch src/main.py --add-data "config.yaml;." --hidden-import PyQt6.QtCore --hidden-import PyQt6.QtGui --hidden-import PyQt6.QtWidgets --hidden-import whoosh --hidden-import docx --hidden-import openpyxl --hidden-import yaml --hidden-import loguru
        
    - name: Create portable package
      run: |
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch
        Copy-Item dist\SmartFileSearch.exe dist\SmartFileSearch\
        Copy-Item config.yaml dist\SmartFileSearch\
        Copy-Item README.md dist\SmartFileSearch\
        Copy-Item start.bat dist\SmartFileSearch\
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch\data\models
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch\data\indexdir
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch\logs
        Compress-Archive -Path dist\SmartFileSearch -DestinationPath dist\SmartFileSearch-portable.zip
      shell: pwsh
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SmartFileSearch-Windows
        path: |
          dist/SmartFileSearch.exe
          dist/SmartFileSearch-portable.zip
          
    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: Smart File Search ${{ github.ref_name }}
        body: |
          # Smart File Search ${{ github.ref_name }}
          
          ## ğŸš€ å¿«é€Ÿå¼€å§‹
          
          ### å®‰è£…ç‰ˆ
          1. ä¸‹è½½ `SmartFileSearch.exe`
          2. åŒå‡»è¿è¡Œ
          3. å¼€å§‹ä½¿ç”¨ï¼
          
          ### ä¾¿æºç‰ˆ
          1. ä¸‹è½½ `SmartFileSearch-portable.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `start.bat` è¿è¡Œ
          
          ## ğŸ“¦ åŠŸèƒ½ç‰¹æ€§
          
          - âœ… å¿«é€Ÿæ–‡ä»¶ç´¢å¼•
          - âœ… å¯åŠ¨ç”»é¢æ˜¾ç¤ºåŠ è½½è¿›åº¦
          - âœ… å¤šçº¿ç¨‹å¤„ç†ï¼Œç•Œé¢æµç•…
          - âœ… æ”¯æŒWord/Excel/TXT
          - âœ… PyQt6ç•Œé¢
          
          ## ğŸ“¦ å®‰è£…åŒ…ä¿¡æ¯
          
          - **å¤§å°**: çº¦ 80MBï¼ˆä¸å«AIæ¨¡å‹ï¼‰
          - **AIåŠŸèƒ½**: å¯é€‰ï¼Œé¦–æ¬¡ä½¿ç”¨æ—¶ä¸‹è½½æ¨¡å‹
          - **å¯åŠ¨æ—¶é—´**: 2-3ç§’
          
          ## ğŸ’¡ æ³¨æ„äº‹é¡¹
          
          - AIæ¨¡å‹ï¼ˆ1.7GBï¼‰å°†åœ¨é¦–æ¬¡ä½¿ç”¨AIåŠŸèƒ½æ—¶è‡ªåŠ¨ä¸‹è½½
          - å¯é€‰æ‹©ä¸ä½¿ç”¨AIåŠŸèƒ½ï¼Œä»…ä½¿ç”¨å¿«é€Ÿæ–‡ä»¶æœç´¢
          
          ## ğŸ“š æ–‡æ¡£
          
          - [ä½¿ç”¨è¯´æ˜](docs/USAGE.md)
          - [é…ç½®æŒ‡å—](docs/QUICK_SETUP.md)
          
        files: |
          dist/SmartFileSearch.exe
          dist/SmartFileSearch-portable.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
