name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 构建 Windows 版本
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install core dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 whoosh python-docx openpyxl PyYAML loguru watchdog chardet pywin32
        pip install pyinstaller pyinstaller-hooks-contrib

    - name: Install llama-cpp-python (CPU version)
      run: |
        # Try precompiled wheel first, fallback to source build
        pip install llama-cpp-python --extra-index-url https://abetlen.github.io/llama-cpp-python/whl/cpu || \
        pip install llama-cpp-python --no-binary :all:
      shell: pwsh
      continue-on-error: true

    - name: Build executable with PyInstaller
      run: |
        pyinstaller build.spec --clean --noconfirm
      shell: pwsh

    - name: Create portable version
      run: |
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable
        Copy-Item dist\SmartFileSearch\SmartFileSearch.exe dist\SmartFileSearch-Portable\
        Copy-Item config.yaml dist\SmartFileSearch-Portable\
        Copy-Item README.md dist\SmartFileSearch-Portable\
        Copy-Item start.bat dist\SmartFileSearch-Portable\ -ErrorAction SilentlyContinue
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable\data\models
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable\data\indexdir
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable\logs

        Set-Content -Path "dist\SmartFileSearch-Portable\README.txt" -Value @"
Smart File Search Portable (Windows)

Usage:
1. Double-click SmartFileSearch.exe to start
2. Or double-click start.bat for verbose output

AI Features:
- llama-cpp-python is bundled (no additional installation needed)
- Just place a GGUF model file in data/models/ folder
- Enable AI in config.yaml: ai.enabled: true
- Recommended model: Phi-2 Q4_K_M (~1.6GB)

Features:
- No installation required
- AI support built-in (just add model)
- Full-text search with Whoosh
- Supports PDF, Word, Excel, text files
"@

        Compress-Archive -Path dist\SmartFileSearch-Portable -DestinationPath dist\SmartFileSearch-Windows-Portable.zip
      shell: pwsh

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SmartFileSearch-Windows
        path: |
          dist/SmartFileSearch/SmartFileSearch.exe
          dist/SmartFileSearch-Windows-Portable.zip

  # 构建 macOS 版本 (Apple Silicon)
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install core dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 whoosh python-docx openpyxl PyYAML loguru watchdog chardet
        pip install pyinstaller pyinstaller-hooks-contrib

    - name: Install llama-cpp-python (Metal version for Apple Silicon)
      run: |
        # Try Metal-enabled wheel first, fallback to CPU version
        CMAKE_ARGS="-DLLAMA_METAL=on" pip install llama-cpp-python --no-cache-dir || \
        pip install llama-cpp-python --extra-index-url https://abetlen.github.io/llama-cpp-python/whl/cpu || \
        pip install llama-cpp-python --no-binary :all:
      continue-on-error: true

    - name: Build executable with PyInstaller
      run: |
        pyinstaller build.spec --clean --noconfirm

    - name: Create portable version
      run: |
        mkdir -p dist/SmartFileSearch-Portable
        cp dist/SmartFileSearch/SmartFileSearch dist/SmartFileSearch-Portable/
        cp config.yaml dist/SmartFileSearch-Portable/
        cp README.md dist/SmartFileSearch-Portable/
        printf '#!/bin/bash\n./SmartFileSearch\n' > dist/SmartFileSearch-Portable/start.sh
        chmod +x dist/SmartFileSearch-Portable/start.sh
        mkdir -p dist/SmartFileSearch-Portable/data/models
        mkdir -p dist/SmartFileSearch-Portable/data/indexdir
        mkdir -p dist/SmartFileSearch-Portable/logs

        cat > dist/SmartFileSearch-Portable/README.txt << 'EOF'
Smart File Search Portable (macOS Apple Silicon)

Usage:
1. Double-click SmartFileSearch to start
2. Or run ./start.sh in terminal for verbose output

AI Features:
- llama-cpp-python is bundled (no additional installation needed)
- Just place a GGUF model file in data/models/ folder
- Enable AI in config.yaml: ai.enabled: true
- GPU acceleration with Metal (Apple Silicon)

Features:
- No installation required
- AI support built-in (just add model)
- Full-text search with Whoosh
- For Apple Silicon Macs (M1/M2/M3)
EOF

        cd dist && zip -r SmartFileSearch-macOS-Portable.zip SmartFileSearch-Portable

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SmartFileSearch-macOS
        path: |
          dist/SmartFileSearch/SmartFileSearch
          dist/SmartFileSearch-macOS-Portable.zip

  # 创建发布
  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract changelog for current version
      id: changelog
      run: |
        VERSION="${GITHUB_REF_NAME#v}"
        CHANGELOG=""

        if [ -f "CHANGELOG.md" ]; then
          CHANGELOG=$(sed -n "/^## \[${VERSION}\]/,/^## \[/p" CHANGELOG.md | sed '$d' | sed '1d')
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG=$(sed -n "/^## \[v${VERSION}\]/,/^## \[/p" CHANGELOG.md | sed '$d' | sed '1d')
          fi
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG=$(sed -n "/^## ${VERSION}/,/^## /p" CHANGELOG.md | sed '$d' | sed '1d')
          fi
        fi

        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="请查看 CHANGELOG.md 获取更新详情。"
        fi

        echo "$CHANGELOG" > /tmp/changelog.txt
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: SmartFileSearch-Windows
        path: dist/windows

    - name: Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: SmartFileSearch-macOS
        path: dist/macos

    - name: Prepare release files
      run: |
        mkdir -p release
        cp dist/windows/SmartFileSearch.exe release/
        cp dist/windows/SmartFileSearch-Windows-Portable.zip release/
        cp dist/macos/SmartFileSearch release/SmartFileSearch-macOS
        cp dist/macos/SmartFileSearch-macOS-Portable.zip release/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Smart File Search ${{ github.ref_name }}
        body_path: /tmp/changelog.txt
        draft: false
        prerelease: false
        files: |
          release/SmartFileSearch.exe
          release/SmartFileSearch-Windows-Portable.zip
          release/SmartFileSearch-macOS
          release/SmartFileSearch-macOS-Portable.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
