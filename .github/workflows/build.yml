name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 构建 Windows 版本
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 whoosh python-docx openpyxl PyYAML loguru watchdog chardet pywin32
        pip install pyinstaller

    - name: Build executable
      run: |
        pyinstaller --clean --noconfirm --onedir --windowed `
          --name SmartFileSearch `
          --add-data "config.yaml;." `
          --add-data "src;src" `
          --hidden-import PyQt6.QtCore `
          --hidden-import PyQt6.QtGui `
          --hidden-import PyQt6.QtWidgets `
          --hidden-import PyQt6.sip `
          --hidden-import whoosh `
          --hidden-import whoosh.fields `
          --hidden-import whoosh.index `
          --hidden-import whoosh.qparser `
          --hidden-import docx `
          --hidden-import docx.opc `
          --hidden-import openpyxl `
          --hidden-import yaml `
          --hidden-import loguru `
          --hidden-import watchdog.observers `
          --hidden-import watchdog.events `
          --hidden-import chardet `
          --paths src `
          src/main.py
      shell: pwsh

    - name: Create portable version
      run: |
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable
        Copy-Item dist\SmartFileSearch\SmartFileSearch.exe dist\SmartFileSearch-Portable\
        Copy-Item config.yaml dist\SmartFileSearch-Portable\
        Copy-Item README.md dist\SmartFileSearch-Portable\ -ErrorAction SilentlyContinue
        Copy-Item start.bat dist\SmartFileSearch-Portable\ -ErrorAction SilentlyContinue
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable\data\models
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable\data\indexdir
        New-Item -ItemType Directory -Force -Path dist\SmartFileSearch-Portable\logs

        Set-Content -Path "dist\SmartFileSearch-Portable\README.txt" -Value "Smart File Search Portable (Windows)`n`nUsage: Double-click SmartFileSearch.exe`n`nAI Features (Optional):`npip install llama-cpp-python`nPlace GGUF model in data/models/`n`nFeatures: Full-text search, PDF/Word/Excel support"

        Compress-Archive -Path dist\SmartFileSearch-Portable -DestinationPath dist\SmartFileSearch-Windows-Portable.zip
      shell: pwsh

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SmartFileSearch-Windows
        path: |
          dist/SmartFileSearch/SmartFileSearch.exe
          dist/SmartFileSearch-Windows-Portable.zip

  # 构建 macOS 版本
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 whoosh python-docx openpyxl PyYAML loguru watchdog chardet
        pip install pyinstaller

    - name: Build executable
      run: |
        pyinstaller --clean --noconfirm --onedir --windowed \
          --name SmartFileSearch \
          --add-data "config.yaml:." \
          --add-data "src:src" \
          --hidden-import PyQt6.QtCore \
          --hidden-import PyQt6.QtGui \
          --hidden-import PyQt6.QtWidgets \
          --hidden-import PyQt6.sip \
          --hidden-import whoosh \
          --hidden-import whoosh.fields \
          --hidden-import whoosh.index \
          --hidden-import whoosh.qparser \
          --hidden-import docx \
          --hidden-import docx.opc \
          --hidden-import openpyxl \
          --hidden-import yaml \
          --hidden-import loguru \
          --hidden-import watchdog.observers \
          --hidden-import watchdog.events \
          --hidden-import chardet \
          --paths src \
          src/main.py

    - name: Create portable version
      run: |
        mkdir -p dist/SmartFileSearch-Portable
        cp dist/SmartFileSearch/SmartFileSearch dist/SmartFileSearch-Portable/
        cp config.yaml dist/SmartFileSearch-Portable/
        cp README.md dist/SmartFileSearch-Portable/ 2>/dev/null || true
        printf '#!/bin/bash\n./SmartFileSearch\n' > dist/SmartFileSearch-Portable/start.sh
        chmod +x dist/SmartFileSearch-Portable/start.sh
        mkdir -p dist/SmartFileSearch-Portable/data/models
        mkdir -p dist/SmartFileSearch-Portable/data/indexdir
        mkdir -p dist/SmartFileSearch-Portable/logs

        cat > dist/SmartFileSearch-Portable/README.txt << 'EOF'
        Smart File Search Portable (macOS)

        Usage: Double-click SmartFileSearch

        AI Features (Optional):
        pip install llama-cpp-python
        Place GGUF model in data/models/

        Features: Full-text search, For Apple Silicon
        EOF

        cd dist && zip -r SmartFileSearch-macOS-Portable.zip SmartFileSearch-Portable

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SmartFileSearch-macOS
        path: |
          dist/SmartFileSearch/SmartFileSearch
          dist/SmartFileSearch-macOS-Portable.zip

  # 创建发布
  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: SmartFileSearch-Windows
        path: dist/windows

    - name: Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: SmartFileSearch-macOS
        path: dist/macos

    - name: Prepare release files
      run: |
        mkdir -p release
        cp dist/windows/SmartFileSearch.exe release/
        cp dist/windows/SmartFileSearch-Windows-Portable.zip release/
        cp dist/macos/SmartFileSearch release/SmartFileSearch-macOS
        cp dist/macos/SmartFileSearch-macOS-Portable.zip release/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Smart File Search ${{ github.ref_name }}
        body: |
          ## 更新说明
          请查看 CHANGELOG.md 获取详细更新内容。

          ## AI 功能
          可选安装：`pip install llama-cpp-python`
          然后将 GGUF 模型放到 data/models/ 目录
        draft: false
        prerelease: false
        files: |
          release/SmartFileSearch.exe
          release/SmartFileSearch-Windows-Portable.zip
          release/SmartFileSearch-macOS
          release/SmartFileSearch-macOS-Portable.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
